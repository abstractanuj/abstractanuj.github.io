
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Sun Screen</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@300;400;500&family=Playfair+Display:ital,wght@0,300;0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              ink: '#1A1A1A',
              paper: '#F2F0E9', 
              accent: '#E65100', // Sun Orange
              surface: '#FFFFFF',
              stone: {
                50: '#FAFAF9',
                100: '#F5F5F4',
                200: '#E7E5E4',
                300: '#D6D3D1',
                400: '#A8A29E',
                500: '#78716C',
                800: '#292524',
                900: '#1C1917',
              }
            },
            fontFamily: {
              serif: ['"Playfair Display"', 'serif'],
              sans: ['"Inter"', 'sans-serif'],
              mono: ['"JetBrains Mono"', 'monospace'],
            },
            cursor: {
              'none': 'none',
            }
          },
        },
      };
    </script>

    <!-- Tone.js for Generative Music -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

    <!-- Babel for in-browser compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Map for Modules - PINNED DEPENDENCIES TO FIX HOOKS ERROR -->
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client?deps=react@18.2.0",
    "react-dom": "https://esm.sh/react-dom@18.2.0?deps=react@18.2.0",
    "framer-motion": "https://esm.sh/framer-motion@10.16.4?deps=react@18.2.0",
    "lucide-react": "https://esm.sh/lucide-react@0.292.0?deps=react@18.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.30.0"
  }
}
</script>

    <!-- App Styles - Isolated -->
    <style>
      /* Aggressive Reset for Isolation */
      html, body {
        margin: 0 !important;
        padding: 0 !important;
        width: 100% !important;
        height: 100% !important;
        background-color: #F2F0E9 !important;
        color: #1A1A1A !important;
        cursor: auto; 
        overflow-x: hidden;
        -webkit-tap-highlight-color: transparent;
      }
      
      @media (min-width: 768px) {
        body, a, button, input, textarea {
          cursor: none !important;
        }
      }
      
      /* Scoped Root */
      #sun-app-root {
        position: relative;
        min-height: 100vh;
        width: 100%;
        background-color: #F2F0E9;
        font-family: 'Inter', sans-serif;
      }

      /* Grid Background */
      .bg-grid-pattern {
        background-size: 60px 60px;
        background-image: 
          linear-gradient(to right, rgba(0,0,0,0.05) 1px, transparent 1px),
          linear-gradient(to bottom, rgba(0,0,0,0.05) 1px, transparent 1px);
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: 0;
        pointer-events: none;
      }

      /* Noise Texture */
      .bg-noise {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: 1;
        opacity: 0.4;
        pointer-events: none;
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        mix-blend-mode: overlay;
      }

      /* Scrollbar */
      ::-webkit-scrollbar { width: 4px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: #D6D3D1; border-radius: 2px; }
      ::-webkit-scrollbar-thumb:hover { background: #A8A29E; }
      
      .custom-scrollbar::-webkit-scrollbar { width: 4px; }
      .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
      .custom-scrollbar::-webkit-scrollbar-thumb { background: #D6D3D1; border-radius: 2px; }

      .hardware-accelerated {
        transform: translateZ(0);
        will-change: transform, opacity;
      }
      
      /* Hide elements when focus mode is active */
      .focus-hidden {
        display: none !important;
      }

      ::selection {
        background: #E65100;
        color: white;
      }

      /* Music Player visualizer bars */
      .music-bar {
        width: 3px;
        background-color: currentColor;
        animation: equalizer 1s ease-in-out infinite;
      }
      @keyframes equalizer {
        0%, 100% { height: 4px; }
        50% { height: 12px; }
      }
    </style>
  <link rel="stylesheet" href="/index.css">
</head>
  <body>
    <div id="root"></div>

    <!-- MAIN APPLICATION SCRIPT -->
    <script type="text/babel" data-type="module">
      import React, { useState, useEffect, useRef, useCallback, useMemo } from 'react';
      import { createRoot } from 'react-dom/client';
      import { createPortal } from 'react-dom';
      
      import { motion, useSpring, useMotionValue, AnimatePresence } from 'framer-motion';
      import { 
        Play, Pause, RefreshCw, Plus, X, Check, Sparkles, Save, Loader2, PenLine, 
        Trash2, Maximize2, Minimize2, Download, Upload, History, Clock, List, 
        BookOpen, Lock, Wallet, Link as LinkIcon, Layers, ChevronRight, ArrowLeft,
        TrendingUp, TrendingDown, ExternalLink, Music, Image as ImageIcon, Volume2, VolumeX,
        SkipForward, Settings
      } from 'lucide-react';

      // --- CONFIG & UTILS ---
      
      const GridSection = {
        POMODORO: 'POMODORO',
        TODO: 'TODO',
        JOURNAL: 'JOURNAL',
        MONEY: 'MONEY',
        BOOKMARKS: 'BOOKMARKS',
        LISTS: 'LISTS',
        NONE: null
      };

      const TimerMode = { FOCUS: 'FOCUS', BREAK: 'BREAK' };

      // 30 Static Prompts
      const JOURNAL_PROMPTS = [
        { topic: "The Present", context: "What is one thing you are grateful for right now, in this exact moment?" },
        { topic: "Daily Focus", context: "What is the single most important thing you need to accomplish today?" },
        { topic: "Reflection", context: "What is a lesson you learned the hard way that you are now thankful for?" },
        { topic: "Inner Calm", context: "Describe a place where you feel completely at peace." },
        { topic: "Self-Talk", context: "If you spoke to yourself the way you speak to your best friend, what would you say?" },
        { topic: "Letting Go", context: "What is one worry or burden you are carrying that you can put down for today?" },
        { topic: "Energy", context: "Who or what gave you energy today? Who or what took it away?" },
        { topic: "Growth", context: "In what way are you a different person today than you were a year ago?" },
        { topic: "Simplicity", context: "What is one thing you can remove from your life to make it simpler?" },
        { topic: "Hope", context: "What is one thing you are looking forward to in the near future?" },
        { topic: "Impact", context: "How do you want people to feel after they interact with you?" },
        { topic: "Silence", context: "Sit in silence for one minute. What thoughts come to the surface?" },
        { topic: "Clarity", context: "What is one decision you have been avoiding? What is the first step?" },
        { topic: "Courage", context: "What would you do today if you knew you could not fail?" },
        { topic: "Connection", context: "Who is someone you appreciate but haven't told lately? Write them a note." },
        { topic: "Nature", context: "When was the last time you felt awe? Describe the moment." },
        { topic: "Habits", context: "Which daily habit is serving you best right now? Which one is holding you back?" },
        { topic: "Joy", context: "List three small things that made you smile in the last 24 hours." },
        { topic: "Learning", context: "What is something new you want to understand better?" },
        { topic: "Forgiveness", context: "Is there anyone (including yourself) you need to forgive to move forward?" },
        { topic: "Values", context: "What is a core value you lived by today?" },
        { topic: "Obstacles", context: "The obstacle is the way. What challenge are you facing that is actually an opportunity?" },
        { topic: "Stillness", context: "What does silence sound like to you today?" },
        { topic: "Future Self", context: "Write a short message to your future self one year from now." },
        { topic: "Generosity", context: "How can you be generous today without spending money?" },
        { topic: "Perspective", context: "Zoom out. How will today's problem matter in 5 years?" },
        { topic: "Body", context: "What is your body telling you it needs right now?" },
        { topic: "Creativity", context: "If you could create anything without judgment, what would it be?" },
        { topic: "Truth", context: "What is a hard truth you have been avoiding?" },
        { topic: "Evening", context: "How do you want to feel when your head hits the pillow tonight?" }
      ];

      // Algorithm: Update at 7 AM IST
      const getDailyPrompt = () => {
         const now = Date.now();
         const IST_OFFSET_MS = 5.5 * 60 * 60 * 1000;
         const SWITCH_HOUR_MS = 7 * 60 * 60 * 1000; // 7 AM
         const ONE_DAY_MS = 24 * 60 * 60 * 1000;
         
         const adjustedTime = now + (IST_OFFSET_MS - SWITCH_HOUR_MS);
         const dayIndex = Math.floor(adjustedTime / ONE_DAY_MS);
         
         const promptIndex = ((dayIndex % JOURNAL_PROMPTS.length) + JOURNAL_PROMPTS.length) % JOURNAL_PROMPTS.length;
         return JOURNAL_PROMPTS[promptIndex];
      };

      const getFormattedDate = () => {
          return new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
      };

      // --- COMPONENTS ---

      const LockScreen = ({ onUnlock }) => {
        const [password, setPassword] = useState("");
        const [error, setError] = useState(false);
        const [shake, setShake] = useState(0);

        const handleSubmit = (e) => {
            e.preventDefault();
            // 'xorgod'
            const inputCodes = password.split('').map(c => c.charCodeAt(0));
            const target = [120, 111, 114, 103, 111, 100];
            
            let match = inputCodes.length === target.length;
            if(match) {
                for(let i=0; i<target.length; i++) {
                    if(inputCodes[i] !== target[i]) match = false;
                }
            }

            if (match) {
                onUnlock();
            } else {
                setError(true);
                setShake(prev => prev + 1);
                setTimeout(() => setError(false), 500);
            }
        };

        return (
            <div className="fixed inset-0 z-[99999] bg-[#F2F0E9] flex items-center justify-center cursor-default">
                 <div className="absolute inset-0 bg-grid-pattern opacity-50"></div>
                 <div className="absolute inset-0 bg-noise opacity-40"></div>
                 <motion.div 
                    initial={{ opacity: 0, scale: 0.9, y: 20 }}
                    animate={{ opacity: 1, scale: 1, y: 0, x: error ? [0, -10, 10, -10, 10, 0] : 0 }}
                    transition={{ type: "spring", duration: 0.6 }}
                    key={shake}
                    className="bg-white p-12 shadow-2xl border border-stone-200 text-center max-w-md w-full mx-4 relative overflow-hidden"
                 >
                    <div className="absolute top-0 left-0 w-full h-1 bg-accent"></div>
                    <div className="mb-6 flex justify-center text-ink"><Lock size={32} strokeWidth={1.5} /></div>
                    <h2 className="font-serif text-3xl text-ink mb-2 tracking-tight">Sun Screen</h2>
                    <p className="font-mono text-[10px] uppercase tracking-[0.2em] text-stone-400 mb-10">Restricted Access</p>
                    <form onSubmit={handleSubmit}>
                        <input 
                            type="password" 
                            value={password}
                            onChange={(e) => setPassword(e.target.value)}
                            placeholder="Passphrase"
                            className="w-full bg-stone-50 border-b border-stone-200 p-4 text-center font-mono text-sm focus:outline-none focus:border-accent transition-all placeholder:text-stone-300 text-ink tracking-widest"
                            autoFocus
                            autoComplete="off"
                        />
                        <button type="submit" className="mt-8 w-full bg-ink text-white py-4 font-mono text-[10px] uppercase tracking-[0.25em] hover:bg-accent transition-all shadow-lg">Authenticate</button>
                    </form>
                 </motion.div>
            </div>
        );
      };

      // Portal helper for cursor
      const Portal = ({ children }) => {
        const [mounted, setMounted] = useState(false);
        useEffect(() => setMounted(true), []);
        if (!mounted) return null;
        return createPortal(children, document.body);
      };

      const CustomCursor = () => {
        const mouseX = useMotionValue(-100);
        const mouseY = useMotionValue(-100);
        const [isVisible, setIsVisible] = useState(false);
        const scaleSpring = useSpring(1, { damping: 20, stiffness: 300 });

        useEffect(() => {
          const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
          if (isTouchDevice) return;
          setIsVisible(true);
          const moveCursor = (e) => { mouseX.set(e.clientX); mouseY.set(e.clientY); };
          const handleMouseOver = (e) => {
            const target = e.target;
            if (target.closest('button, a, input, textarea, [role="button"]')) {
              scaleSpring.set(2.5);
            } else {
              scaleSpring.set(1);
            }
          };
          const handleMouseDown = () => scaleSpring.set(0.8);
          const handleMouseUp = () => scaleSpring.set(1);

          window.addEventListener('mousemove', moveCursor, { passive: true });
          window.addEventListener('mouseover', handleMouseOver, { passive: true });
          window.addEventListener('mousedown', handleMouseDown);
          window.addEventListener('mouseup', handleMouseUp);
          return () => {
            window.removeEventListener('mousemove', moveCursor);
            window.removeEventListener('mouseover', handleMouseOver);
            window.removeEventListener('mousedown', handleMouseDown);
            window.removeEventListener('mouseup', handleMouseUp);
          };
        }, [mouseX, mouseY, scaleSpring]);

        if (!isVisible) return null;
        return (
          <Portal>
            <motion.div className="fixed top-0 left-0 w-2 h-2 bg-accent rounded-full pointer-events-none z-[9999]" style={{ left: mouseX, top: mouseY, x: "-50%", y: "-50%" }} />
            <motion.div className="fixed top-0 left-0 w-8 h-8 rounded-full pointer-events-none z-[9998] mix-blend-difference border border-white" style={{ left: mouseX, top: mouseY, x: "-50%", y: "-50%", scale: scaleSpring }} />
          </Portal>
        );
      };

      // --- SCENES & MUSIC DATA ---
      const SCENES = [
        { id: 'city', name: 'Tokyo Night', url: 'https://images.unsplash.com/photo-1542931287-023b922fa89b?q=80&w=2073&auto=format&fit=crop' },
        { id: 'rain', name: 'Rainy Cafe', url: 'https://images.unsplash.com/photo-1515694346937-94d85e41e6f0?q=80&w=2070&auto=format&fit=crop' },
        { id: 'nature', name: 'Deep Forest', url: 'https://images.unsplash.com/photo-1441974231531-c6227db76b6e?q=80&w=2070&auto=format&fit=crop' },
        { id: 'gradient', name: 'Flow State', url: 'https://images.unsplash.com/photo-1579546929518-9e396f3cc809?q=80&w=2070&auto=format&fit=crop' },
        { id: 'minimal', name: 'Studio', url: '' } // Empty string = CSS gradient
      ];

      const TRACKS = [
        { id: 'rain', name: 'Heavy Rain', url: 'https://assets.mixkit.co/active_storage/sfx/1109/1109-preview.mp3', type: 'audio' },
        { id: 'white', name: 'White Noise', url: 'https://assets.mixkit.co/active_storage/sfx/2281/2281-preview.mp3', type: 'audio' },
        { id: 'fire', name: 'Campfire', url: 'https://assets.mixkit.co/active_storage/sfx/138/138-preview.mp3', type: 'audio' },
        { id: 'classical', name: 'Classical Flow', type: 'gen' } // Tone.js Generative
      ];

      const Pomodoro = ({ isActiveProp, onStart, onStop }) => {
        const [timeLeft, setTimeLeft] = useState(25 * 60);
        const [mode, setMode] = useState(TimerMode.FOCUS);
        const [task, setTask] = useState("");
        const [sceneIndex, setSceneIndex] = useState(0);
        const [currentTrack, setCurrentTrack] = useState(null);
        const [isPlayingMusic, setIsPlayingMusic] = useState(false);
        const [volume, setVolume] = useState(0.5);

        const canvasRef = useRef(null);
        const requestRef = useRef(0);
        const timeRef = useRef(0);
        const audioRef = useRef(null);
        const toneRef = useRef(null); // Stores synth, reverb, loop

        const currentScene = SCENES[sceneIndex];

        // --- Tone.js Classical Generator ---
        const startClassicalMusic = async () => {
            if (!window.Tone) return;
            
            // Resume context (browser policy)
            await window.Tone.start();

            if (toneRef.current) return; // Already setup

            const reverb = new window.Tone.Reverb({ decay: 5, wet: 0.4 }).toDestination();
            await reverb.generate();

            const synth = new window.Tone.PolySynth(window.Tone.Synth, {
                oscillator: { type: "triangle" }, // Softer than square
                envelope: { attack: 0.05, decay: 0.2, sustain: 0.4, release: 2 }
            }).connect(reverb);
            synth.volume.value = -10; // Softer default

            // A Satie-esque GymnopÃ©die progression generator
            // Slow, spacious chords
            const chords = [
                ["C4", "E4", "G4", "B4"], // C Maj7
                ["A3", "C4", "E4", "G4"], // A min7
                ["F3", "A3", "C4", "E4"], // F Maj7
                ["G3", "B3", "D4", "F4"], // G Dom7
            ];

            let index = 0;
            const loop = new window.Tone.Loop((time) => {
                // Play a chord every measure, but arpeggiated slightly
                const chord = chords[index % chords.length];
                // Randomize velocity for human feel
                const vel = 0.5 + Math.random() * 0.3;
                
                // Play full chord softly
                synth.triggerAttackRelease(chord, "2n", time, vel);
                
                // Occasionally add a high melody note
                if (Math.random() > 0.5) {
                    const melodyNotes = ["E5", "G5", "B5", "D5"];
                    const note = melodyNotes[Math.floor(Math.random() * melodyNotes.length)];
                    synth.triggerAttackRelease(note, "4n", time + 1, vel * 0.8);
                }

                index = (index + 1) % chords.length; // Next chord
                // Occasionally stay on same chord
                if(Math.random() > 0.8) index = (index - 1 + chords.length) % chords.length;

            }, "2n").start(0);

            window.Tone.Transport.bpm.value = 40; // Very slow
            window.Tone.Transport.start();

            toneRef.current = { synth, reverb, loop };
        };

        const stopClassicalMusic = () => {
             if (toneRef.current) {
                 toneRef.current.loop.stop();
                 toneRef.current.loop.dispose();
                 toneRef.current.synth.dispose();
                 toneRef.current.reverb.dispose();
                 toneRef.current = null;
                 window.Tone.Transport.stop();
             }
        };

        // Music Logic Manager
        useEffect(() => {
          // Setup HTML5 Audio
          if (!audioRef.current) audioRef.current = new Audio();
          const audio = audioRef.current;
          audio.loop = true;
          audio.volume = volume;

          // Cleanup Previous
          const handleMusicChange = async () => {
              if (isPlayingMusic && currentTrack) {
                  if (currentTrack.type === 'gen') {
                      audio.pause();
                      await startClassicalMusic();
                  } else {
                      stopClassicalMusic();
                      if (audio.src !== currentTrack.url) {
                          audio.src = currentTrack.url;
                      }
                      audio.play().catch(e => console.log("Audio play fail", e));
                  }
              } else {
                  audio.pause();
                  stopClassicalMusic();
              }
          };

          handleMusicChange();

          return () => {
              audio.pause();
              stopClassicalMusic();
          };
        }, [currentTrack, isPlayingMusic]);

        // Volume Effect
        useEffect(() => {
            if(audioRef.current) audioRef.current.volume = volume;
            if(toneRef.current && window.Tone) {
                // Map 0-1 volume to Decibels (-60 to 0)
                const db = volume === 0 ? -Infinity : 20 * Math.log10(volume) - 10; 
                toneRef.current.synth.volume.rampTo(db, 0.1);
            }
        }, [volume]);

        const formatTime = (seconds) => {
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            return `${m}:${s.toString().padStart(2, '0')}`;
        };

        // Timer Logic
        useEffect(() => {
          let interval;
          if (isActiveProp && timeLeft > 0) interval = setInterval(() => setTimeLeft((prev) => prev - 1), 1000);
          else if (timeLeft === 0) {
              onStop(); 
          }
          return () => clearInterval(interval);
        }, [isActiveProp, timeLeft, onStop]);

        // Sine Wave Visualizer
        const animate = useCallback(() => {
          const canvas = canvasRef.current;
          if (!canvas) return;
          const ctx = canvas.getContext('2d');
          if (!ctx) return;
          
          const dpr = window.devicePixelRatio || 1;
          const rect = canvas.getBoundingClientRect();
          if (canvas.width !== rect.width * dpr || canvas.height !== rect.height * dpr) {
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);
          }
          
          const width = rect.width;
          const height = rect.height;

          ctx.clearRect(0, 0, width, height);
          
          const speed = isActiveProp ? 0.05 : 0.01;
          timeRef.current += speed;
          
          ctx.beginPath();
          ctx.moveTo(0, height);
          
          const lines = 3;
          for (let i = 0; i < lines; i++) {
              ctx.beginPath();
              const amplitude = (height * 0.15) * (isPlayingMusic ? 1.5 : 0.8);
              const frequency = 0.01 + (i * 0.005);
              const phase = timeRef.current + (i * 2);
              
              ctx.moveTo(0, height);
              for (let x = 0; x <= width; x += 10) {
                 const y = height - (Math.abs(Math.sin(x * frequency + phase)) * amplitude) - 10;
                 ctx.lineTo(x, y);
              }
              // Fill gradient
              ctx.lineTo(width, height);
              ctx.lineTo(0, height);
              ctx.fillStyle = `rgba(255, 255, 255, ${0.1 + (i * 0.05)})`;
              ctx.fill();
          }
          
          requestRef.current = requestAnimationFrame(animate);
        }, [isActiveProp, isPlayingMusic]);

        useEffect(() => {
           requestRef.current = requestAnimationFrame(animate);
           return () => cancelAnimationFrame(requestRef.current);
        }, [animate]);

        return (
          <div className="h-full w-full relative overflow-hidden text-white group select-none">
              {/* Background Image */}
              <AnimatePresence mode="wait">
                  {currentScene.url ? (
                    <motion.img 
                        key={currentScene.id}
                        src={currentScene.url} 
                        className="absolute inset-0 w-full h-full object-cover transition-transform duration-[20s] ease-linear scale-105"
                        initial={{ opacity: 0 }}
                        animate={{ opacity: 1, scale: isActiveProp ? 1.1 : 1.05 }}
                        exit={{ opacity: 0 }}
                    />
                  ) : (
                    <motion.div key="minimal" className="absolute inset-0 bg-gradient-to-br from-stone-800 to-black" />
                  )}
              </AnimatePresence>
              
              {/* Overlay */}
              <div className="absolute inset-0 bg-black/40 backdrop-blur-[2px]"></div>

              {/* Top Controls */}
              <div className="absolute top-0 left-0 w-full p-6 flex justify-between items-start z-20">
                   <div className="flex gap-2">
                       <button onClick={(e) => { e.stopPropagation(); setMode(TimerMode.FOCUS); setTimeLeft(1500); onStop(); }} className={`px-4 py-1.5 rounded-full text-xs font-medium backdrop-blur-md border transition-all ${mode === TimerMode.FOCUS ? 'bg-white/20 border-white/50 text-white' : 'bg-transparent border-transparent text-white/60 hover:bg-white/10'}`}>Focus</button>
                       <button onClick={(e) => { e.stopPropagation(); setMode(TimerMode.BREAK); setTimeLeft(300); onStop(); }} className={`px-4 py-1.5 rounded-full text-xs font-medium backdrop-blur-md border transition-all ${mode === TimerMode.BREAK ? 'bg-white/20 border-white/50 text-white' : 'bg-transparent border-transparent text-white/60 hover:bg-white/10'}`}>Break</button>
                   </div>
                   <button onClick={(e) => { e.stopPropagation(); setSceneIndex((prev) => (prev + 1) % SCENES.length); }} className="p-2 rounded-full bg-black/20 hover:bg-white/20 backdrop-blur-md text-white/80 transition-colors border border-white/10">
                       <ImageIcon size={18} />
                   </button>
              </div>

              {/* Main Content */}
              <div className="relative z-10 flex flex-col items-center justify-center h-full pt-10">
                  
                  {/* Task Input */}
                  <div className="mb-6 relative w-full max-w-md text-center group/input">
                      {!isActiveProp ? (
                        <div className="flex items-center justify-center gap-2 text-white/60 hover:text-white transition-colors">
                            <PenLine size={14} />
                            <input 
                                type="text" 
                                value={task} 
                                onChange={(e) => setTask(e.target.value)} 
                                placeholder="What are you working on?" 
                                className="bg-transparent border-none text-center font-sans text-lg md:text-xl placeholder:text-white/40 focus:ring-0 focus:outline-none w-full"
                                onClick={(e) => e.stopPropagation()}
                            />
                        </div>
                      ) : (
                         <motion.div initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} className="text-xl md:text-2xl font-medium tracking-wide">
                            {task || "Deep Focus"}
                         </motion.div>
                      )}
                  </div>

                  {/* Timer */}
                  <motion.h1 
                    className="text-[6rem] md:text-[10rem] lg:text-[12rem] leading-none font-sans font-bold tracking-tighter tabular-nums drop-shadow-2xl"
                    layout
                  >
                      {formatTime(timeLeft)}
                  </motion.h1>

                  {/* Play Button */}
                  <motion.button 
                    whileHover={{ scale: 1.05 }}
                    whileTap={{ scale: 0.95 }}
                    onClick={(e) => { e.stopPropagation(); isActiveProp ? onStop() : onStart(); }} 
                    className="mt-8 px-10 py-4 bg-white text-black rounded-full font-medium text-lg tracking-wide hover:bg-white/90 transition-colors shadow-[0_0_40px_rgba(255,255,255,0.3)] flex items-center gap-2"
                  >
                      {isActiveProp ? "PAUSE" : "START SESSION"}
                  </motion.button>
              </div>

              {/* Bottom Visualizer Canvas */}
              <div className="absolute bottom-0 left-0 w-full h-32 pointer-events-none opacity-60">
                  <canvas ref={canvasRef} className="w-full h-full" />
              </div>

              {/* Music Player Widget */}
              <div className="absolute bottom-6 left-6 z-30" onClick={(e) => e.stopPropagation()}>
                  <div className="flex items-center gap-3 p-2 pr-4 bg-black/40 backdrop-blur-xl border border-white/10 rounded-full hover:bg-black/50 transition-colors">
                      <button 
                        onClick={() => {
                            if (!currentTrack) setCurrentTrack(TRACKS[0]);
                            setIsPlayingMusic(!isPlayingMusic);
                        }}
                        className="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center hover:bg-white/20 transition-colors"
                      >
                          {isPlayingMusic ? 
                            <div className="flex gap-[3px] items-end h-4">
                                <span className="music-bar h-2"></span>
                                <span className="music-bar h-4" style={{ animationDelay: '0.1s' }}></span>
                                <span className="music-bar h-3" style={{ animationDelay: '0.2s' }}></span>
                            </div> 
                            : <Play size={16} fill="currentColor"/> 
                          }
                      </button>
                      
                      <div className="flex flex-col min-w-[100px]">
                          <span className="text-[10px] font-bold uppercase tracking-widest text-white/50">Ambience</span>
                          <span className="text-xs font-medium cursor-pointer hover:text-accent transition-colors" onClick={() => {
                              const nextIdx = currentTrack ? (TRACKS.indexOf(currentTrack) + 1) % TRACKS.length : 0;
                              setCurrentTrack(TRACKS[nextIdx]);
                              if(!isPlayingMusic) setIsPlayingMusic(true);
                          }}>
                              {currentTrack ? currentTrack.name : "Select Sound"}
                          </span>
                      </div>

                      <div className="h-6 w-[1px] bg-white/10 mx-1"></div>
                      
                      <button onClick={() => setVolume(v => v === 0 ? 0.5 : 0)} className="text-white/60 hover:text-white">
                          {volume === 0 ? <VolumeX size={16}/> : <Volume2 size={16}/>}
                      </button>
                  </div>
              </div>
          </div>
        );
      };

      const TodoList = () => {
        const [todos, setTodos] = useState(() => JSON.parse(localStorage.getItem('sunscreen_todos') || '[{"id":"1","text":"Primary Task","completed":false}]'));
        const [newTodo, setNewTodo] = useState('');
        useEffect(() => localStorage.setItem('sunscreen_todos', JSON.stringify(todos)), [todos]);

        return (
          <div className="h-full flex flex-col p-6">
            <div className="flex justify-between items-center mb-4">
              <h2 className="font-serif text-2xl italic text-ink">Priorities</h2>
              <span className="font-mono text-[9px] tracking-widest text-stone-400">{todos.filter(t => !t.completed).length} LEFT</span>
            </div>
            <div className="flex-1 overflow-y-auto space-y-1 pr-2 custom-scrollbar">
              <AnimatePresence mode="popLayout">
                {todos.map((todo) => (
                  <motion.div key={todo.id} layout initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} className="group flex items-center justify-between p-2 hover:bg-white/50 rounded-sm">
                    <div className="flex items-center gap-3 flex-1">
                      <button onClick={(e) => { e.stopPropagation(); setTodos(todos.map(t => t.id === todo.id ? { ...t, completed: !t.completed } : t)); }} className={`w-3 h-3 rounded-full border flex items-center justify-center transition-all ${todo.completed ? 'bg-ink border-ink' : 'border-stone-400 hover:border-accent'}`}>{todo.completed && <Check size={8} className="text-white" />}</button>
                      <span className={`font-sans text-xs ${todo.completed ? 'line-through text-stone-300' : 'text-ink'}`}>{todo.text}</span>
                    </div>
                    <button onClick={(e) => { e.stopPropagation(); setTodos(todos.filter(t => t.id !== todo.id)); }} className="opacity-0 group-hover:opacity-100 text-stone-300 hover:text-red-500"><Trash2 size={10} /></button>
                  </motion.div>
                ))}
              </AnimatePresence>
            </div>
            <form onSubmit={(e) => { e.preventDefault(); e.stopPropagation(); if(newTodo.trim()) { setTodos([...todos, { id: Date.now().toString(), text: newTodo, completed: false }]); setNewTodo(''); } }} className="mt-4 relative" onClick={e => e.stopPropagation()}>
              <input type="text" value={newTodo} onChange={(e) => setNewTodo(e.target.value)} placeholder="Add priority..." className="w-full bg-transparent border-b border-stone-200 py-2 pr-6 font-sans text-xs focus:outline-none focus:border-ink" />
              <button type="submit" className="absolute right-0 top-2 text-stone-300 hover:text-ink"><Plus size={14} /></button>
            </form>
          </div>
        );
      };

      const MoneyTracker = () => {
          const [transactions, setTransactions] = useState(() => JSON.parse(localStorage.getItem('sunscreen_money') || '[]'));
          const [amount, setAmount] = useState('');
          const [desc, setDesc] = useState('');
          const [type, setType] = useState('expense'); 
          
          useEffect(() => localStorage.setItem('sunscreen_money', JSON.stringify(transactions)), [transactions]);
          const balance = transactions.reduce((acc, curr) => curr.type === 'income' ? acc + curr.amount : acc - curr.amount, 0);

          const addTransaction = (e) => {
              e.preventDefault(); e.stopPropagation();
              if(!amount || !desc) return;
              const newItem = { id: Date.now(), amount: parseFloat(amount), desc, type, date: new Date().toISOString() };
              setTransactions([newItem, ...transactions]);
              setAmount(''); setDesc('');
          };

          return (
            <div className="h-full flex flex-col p-6 relative overflow-hidden">
                <div className="flex justify-between items-start mb-6 z-10">
                    <h2 className="font-serif text-2xl italic text-ink">Wallet</h2>
                    <div className="text-right">
                        <span className="font-mono text-[9px] uppercase text-stone-400 tracking-widest block mb-1">Total</span>
                        <span className={`font-mono text-xl ${balance >= 0 ? 'text-ink' : 'text-accent'}`}>{balance < 0 ? '-' : ''}${Math.abs(balance).toFixed(2)}</span>
                    </div>
                </div>
                <div className="flex-1 overflow-y-auto space-y-2 pr-2 custom-scrollbar z-10 mb-4">
                    {transactions.map(t => (
                        <div key={t.id} className="flex justify-between items-center text-xs p-2 border-b border-stone-100 hover:bg-white/50">
                            <div className="flex flex-col"><span className="font-medium text-stone-700">{t.desc}</span></div>
                            <span className={`font-mono ${t.type === 'income' ? 'text-green-600' : 'text-stone-500'}`}>{t.type === 'income' ? '+' : '-'}{t.amount.toFixed(2)}</span>
                        </div>
                    ))}
                </div>
                <form onSubmit={addTransaction} className="z-10 bg-white/40 p-3 rounded-sm border border-stone-100" onClick={e => e.stopPropagation()}>
                    <div className="flex gap-2 mb-2">
                        <button type="button" onClick={() => setType('expense')} className={`flex-1 py-1 text-[9px] uppercase tracking-widest border transition-colors ${type === 'expense' ? 'bg-ink text-white border-ink' : 'border-stone-200 text-stone-400'}`}>Exp</button>
                        <button type="button" onClick={() => setType('income')} className={`flex-1 py-1 text-[9px] uppercase tracking-widest border transition-colors ${type === 'income' ? 'bg-stone-500 text-white border-stone-500' : 'border-stone-200 text-stone-400'}`}>Inc</button>
                    </div>
                    <div className="flex gap-2">
                        <input type="number" value={amount} onChange={e => setAmount(e.target.value)} placeholder="0.00" className="w-16 bg-transparent border-b border-stone-300 text-xs py-1 focus:outline-none" step="0.01"/>
                        <input type="text" value={desc} onChange={e => setDesc(e.target.value)} placeholder="Description" className="flex-1 bg-transparent border-b border-stone-300 text-xs py-1 focus:outline-none"/>
                        <button type="submit" className="text-ink hover:text-accent"><Plus size={14} /></button>
                    </div>
                </form>
            </div>
          );
      };

      const Bookmarks = () => {
          const [links, setLinks] = useState(() => JSON.parse(localStorage.getItem('sunscreen_bookmarks') || '[]'));
          const [newUrl, setNewUrl] = useState('');
          const [newTitle, setNewTitle] = useState('');
          const [isAdding, setIsAdding] = useState(false);
          useEffect(() => localStorage.setItem('sunscreen_bookmarks', JSON.stringify(links)), [links]);

          const addLink = (e) => {
              e.preventDefault(); e.stopPropagation();
              if(!newUrl) return;
              let url = newUrl;
              if (!/^https?:\/\//i.test(url)) url = 'https://' + url;
              const title = newTitle || new URL(url).hostname;
              setLinks([...links, { id: Date.now(), url, title }]);
              setNewUrl(''); setNewTitle(''); setIsAdding(false);
          };

          return (
              <div className="h-full flex flex-col p-6">
                  <div className="flex justify-between items-center mb-4">
                      <h2 className="font-serif text-2xl italic text-ink">Links</h2>
                      <button onClick={(e) => { e.stopPropagation(); setIsAdding(!isAdding); }} className="text-stone-400 hover:text-ink"><Plus size={16} /></button>
                  </div>
                  <div className="flex-1 grid grid-cols-2 md:grid-cols-3 gap-3 overflow-y-auto custom-scrollbar content-start">
                      {links.map(link => (
                          <a key={link.id} href={link.url} target="_blank" rel="noopener noreferrer" className="block p-3 bg-stone-50 hover:bg-white border border-stone-100 hover:border-stone-300 transition-all rounded-sm group relative" onClick={e => e.stopPropagation()}>
                              <div className="absolute top-1 right-1 opacity-0 group-hover:opacity-100 cursor-pointer p-1 text-stone-300 hover:text-red-500" onClick={(e) => { e.preventDefault(); e.stopPropagation(); setLinks(links.filter(l => l.id !== link.id)); }}><Trash2 size={10} /></div>
                              <ExternalLink size={12} className="text-stone-300 mb-2"/>
                              <p className="font-sans text-xs font-medium text-ink truncate">{link.title}</p>
                              <p className="font-mono text-[9px] text-stone-400 truncate">{new URL(link.url).hostname}</p>
                          </a>
                      ))}
                      {isAdding && (
                          <form onSubmit={addLink} className="col-span-2 p-3 bg-white border border-stone-200 shadow-sm" onClick={e => e.stopPropagation()}>
                              <input value={newTitle} onChange={e => setNewTitle(e.target.value)} placeholder="Title" className="w-full text-xs mb-2 border-b border-stone-200 pb-1 focus:outline-none"/>
                              <div className="flex gap-2">
                                  <input value={newUrl} onChange={e => setNewUrl(e.target.value)} placeholder="url.com" className="flex-1 text-xs border-b border-stone-200 pb-1 focus:outline-none" autoFocus/>
                                  <button type="submit" className="text-xs text-ink font-bold">ADD</button>
                              </div>
                          </form>
                      )}
                  </div>
              </div>
          );
      };

      const MultiList = () => {
          const [lists, setLists] = useState(() => JSON.parse(localStorage.getItem('sunscreen_lists') || '[{"id":"1","title":"Reading","items":[]}]'));
          const [activeListId, setActiveListId] = useState(null);
          const [newItem, setNewItem] = useState('');
          const [newListTitle, setNewListTitle] = useState('');
          const [isCreating, setIsCreating] = useState(false);
          
          useEffect(() => localStorage.setItem('sunscreen_lists', JSON.stringify(lists)), [lists]);

          const activeList = lists.find(l => l.id === activeListId);

          const addItem = (e) => {
              e.preventDefault(); e.stopPropagation();
              if(!newItem || !activeListId) return;
              const updatedLists = lists.map(l => {
                  if(l.id === activeListId) return { ...l, items: [...l.items, { id: Date.now(), text: newItem, completed: false }] };
                  return l;
              });
              setLists(updatedLists); setNewItem('');
          };

          const toggleItem = (itemId) => {
               const updatedLists = lists.map(l => {
                  if(l.id === activeListId) return { ...l, items: l.items.map(i => i.id === itemId ? { ...i, completed: !i.completed } : i) };
                  return l;
              });
              setLists(updatedLists);
          };

          const createList = (e) => {
              e.preventDefault(); e.stopPropagation();
              if(!newListTitle) return;
              setLists([...lists, { id: Date.now().toString(), title: newListTitle, items: [] }]);
              setNewListTitle(''); setIsCreating(false);
          };

          // Updated colors to match theme
          if (activeListId && activeList) {
              return (
                  <div className="h-full flex flex-col p-6">
                      <div className="flex items-center gap-2 mb-4">
                          <button onClick={(e) => { e.stopPropagation(); setActiveListId(null); }} className="p-1 hover:bg-stone-100 rounded-full transition-colors"><ArrowLeft size={16}/></button>
                          <h2 className="font-serif text-xl italic text-ink">{activeList.title}</h2>
                      </div>
                      <div className="flex-1 overflow-y-auto space-y-1 custom-scrollbar">
                          {activeList.items.map(item => (
                              <div key={item.id} className="flex items-center gap-3 p-2 hover:bg-stone-50 cursor-pointer" onClick={(e) => { e.stopPropagation(); toggleItem(item.id); }}>
                                  <div className={`w-3 h-3 border rounded-full transition-colors ${item.completed ? 'bg-stone-400 border-stone-400' : 'border-stone-300'}`}></div>
                                  <span className={`text-xs ${item.completed ? 'line-through text-stone-300' : 'text-stone-700'}`}>{item.text}</span>
                              </div>
                          ))}
                      </div>
                      <form onSubmit={addItem} className="mt-2 flex gap-2" onClick={e => e.stopPropagation()}>
                          <input value={newItem} onChange={e => setNewItem(e.target.value)} placeholder="Add item..." className="flex-1 bg-transparent border-b border-stone-200 text-xs py-1 focus:outline-none"/>
                          <button type="submit"><Plus size={14}/></button>
                      </form>
                  </div>
              );
          }

          return (
              <div className="h-full flex flex-col p-6">
                  <div className="flex justify-between items-center mb-4">
                      <h2 className="font-serif text-2xl italic text-ink">Collections</h2>
                      <button onClick={(e) => { e.stopPropagation(); setIsCreating(!isCreating); }} className="text-stone-400 hover:text-ink"><Plus size={16}/></button>
                  </div>
                  <div className="flex-1 overflow-y-auto space-y-2 custom-scrollbar">
                      {isCreating && (
                          <form onSubmit={createList} className="mb-2 flex gap-2" onClick={e => e.stopPropagation()}>
                              <input value={newListTitle} onChange={e => setNewListTitle(e.target.value)} placeholder="Name" className="flex-1 text-xs border-b border-stone-300 py-1 focus:outline-none" autoFocus/>
                              <button type="submit" className="text-[9px] font-bold">NEW</button>
                          </form>
                      )}
                      {lists.map(list => (
                          <div key={list.id} onClick={(e) => { e.stopPropagation(); setActiveListId(list.id); }} className="flex justify-between items-center p-3 bg-stone-50 hover:bg-white border border-stone-100 cursor-pointer group rounded-sm transition-all">
                              <span className="font-sans text-sm text-ink">{list.title}</span>
                              <div className="flex items-center gap-2">
                                  <span className="text-[9px] text-stone-400">{list.items.length}</span>
                                  <ChevronRight size={14} className="text-stone-300 group-hover:text-ink"/>
                              </div>
                          </div>
                      ))}
                  </div>
              </div>
          );
      };

      const Journal = () => {
        const [entries, setEntries] = useState(() => JSON.parse(localStorage.getItem('sunscreen_journal') || '[]'));
        const [currentContent, setCurrentContent] = useState('');
        const [prompt, setPrompt] = useState(null);
        const [isExpanded, setIsExpanded] = useState(false);
        const [showHistory, setShowHistory] = useState(false);
        const [lastSaved, setLastSaved] = useState(null);
        
        // Ref to keep track of latest content inside interval closure
        const contentRef = useRef('');

        useEffect(() => {
           // Restore Draft on Mount
           const draft = localStorage.getItem('sunscreen_journal_draft');
           if(draft) {
               setCurrentContent(draft);
               contentRef.current = draft;
               setLastSaved(new Date());
           }
           setPrompt(getDailyPrompt());
        }, []);

        // Sync ref and state
        useEffect(() => {
            contentRef.current = currentContent;
        }, [currentContent]);

        useEffect(() => localStorage.setItem('sunscreen_journal', JSON.stringify(entries)), [entries]);

        // Autosave Interval: 30 Seconds
        useEffect(() => {
            const saveDraft = () => {
                const current = contentRef.current;
                if(current) {
                    localStorage.setItem('sunscreen_journal_draft', current);
                    setLastSaved(new Date());
                }
            };

            const intervalId = setInterval(saveDraft, 30000); // 30 seconds
            
            // Safety: Save on unload as well
            const handleUnload = () => saveDraft();
            window.addEventListener('beforeunload', handleUnload);

            return () => {
                clearInterval(intervalId);
                window.removeEventListener('beforeunload', handleUnload);
            };
        }, []);

        const saveEntry = (e) => {
          if(e) e.stopPropagation();
          if(!currentContent.trim()) return;
          const newEntry = { id: Date.now(), date: new Date().toISOString(), topic: prompt?.topic, prompt: prompt?.context, content: currentContent };
          setEntries([newEntry, ...entries]);
          setCurrentContent('');
          localStorage.removeItem('sunscreen_journal_draft');
          setLastSaved(null);
        };

        const exportData = (e) => {
            if(e) e.stopPropagation();
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(entries));
            const node = document.createElement('a');
            node.setAttribute("href", dataStr);
            node.setAttribute("download", "sunscreen_journal.json");
            document.body.appendChild(node); node.click(); node.remove();
        };
        
        const importData = (e) => {
            e.stopPropagation();
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            input.onchange = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const imported = JSON.parse(e.target.result);
                        if (Array.isArray(imported)) {
                            // Merge and de-dupe based on ID
                            const currentIds = new Set(entries.map(en => en.id));
                            const uniqueNew = imported.filter(en => !currentIds.has(en.id));
                            setEntries([...uniqueNew, ...entries]);
                            alert(`Imported ${uniqueNew.length} entries.`);
                        }
                    } catch (err) {
                        alert("Invalid file format");
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        };

        const getSavedTime = () => {
            if (!lastSaved) return '';
            return `SAVED ${lastSaved.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
        };

        return (
          <>
            <div className="h-full flex flex-col p-6 bg-[#FAF9F6]">
                <div className="flex justify-between items-start mb-2">
                    <div>
                        <h2 className="font-serif text-2xl italic text-ink">Reflection</h2>
                        <span className="font-mono text-[9px] text-accent uppercase tracking-widest">{getFormattedDate()}</span>
                    </div>
                    <div className="flex gap-1">
                        <button onClick={(e) => { e.stopPropagation(); setIsExpanded(true); }} className="p-1 text-stone-300 hover:text-ink"><Maximize2 size={14} /></button>
                    </div>
                </div>
                <div className="mb-2 min-h-[40px]">
                     <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} key={prompt?.topic}>
                        <p className="font-serif text-sm text-stone-600 leading-snug line-clamp-2">{prompt?.context}</p>
                     </motion.div>
                </div>
                <textarea value={currentContent} onChange={(e) => setCurrentContent(e.target.value)} placeholder="Write here..." className="flex-1 w-full bg-transparent border-none resize-none focus:ring-0 font-sans text-stone-500 text-sm p-0 custom-scrollbar" onClick={(e) => e.stopPropagation()}/>
                {lastSaved && <div className="text-right font-mono text-[9px] text-stone-300 mt-1">{getSavedTime()}</div>}
            </div>

            <AnimatePresence>
                {isExpanded && (
                    <Portal>
                        <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} className="fixed inset-0 z-[100] bg-[#F2F0E9] flex flex-col md:flex-row overflow-hidden" onClick={(e) => e.stopPropagation()}>
                            <CustomCursor />
                            <div className={`w-full md:w-80 bg-[#EBE9E2] border-r border-stone-200 flex flex-col transition-all ${showHistory ? 'translate-x-0' : '-translate-x-full md:translate-x-0 absolute md:relative z-10 h-full'}`}>
                                <div className="p-6 border-b border-stone-200 flex justify-between"><h3 className="font-serif text-xl italic">Archive</h3><button onClick={() => setShowHistory(false)} className="md:hidden"><X size={18}/></button></div>
                                <div className="flex-1 overflow-y-auto p-4 space-y-4">{entries.map(e => (<div key={e.id} className="p-3 bg-white/60 hover:bg-white rounded-sm cursor-pointer" onClick={() => { setCurrentContent(e.content); setShowHistory(false); }}><div className="text-[9px] font-mono text-stone-400">{new Date(e.date).toLocaleDateString()}</div><div className="text-xs text-ink truncate">{e.prompt}</div></div>))}</div>
                                <div className="p-4 border-t border-stone-200 flex gap-2">
                                    <button onClick={exportData} className="flex-1 flex items-center justify-center gap-2 py-2 text-[10px] font-mono uppercase bg-white rounded-sm"><Download size={12}/> Backup</button>
                                    <button onClick={importData} className="flex-1 flex items-center justify-center gap-2 py-2 text-[10px] font-mono uppercase bg-white rounded-sm"><Upload size={12}/> Import</button>
                                </div>
                            </div>
                            <div className="flex-1 flex flex-col relative h-full p-8 md:p-16 max-w-4xl mx-auto">
                                <button onClick={() => setShowHistory(!showHistory)} className="md:hidden absolute top-4 left-4"><History size={20}/></button>
                                <span className="font-mono text-xs text-accent uppercase tracking-[0.2em] text-center mb-6">{getFormattedDate()}</span>
                                <h2 className="font-serif text-2xl md:text-4xl text-ink text-center mb-12">{prompt?.context}</h2>
                                <textarea value={currentContent} onChange={(e) => setCurrentContent(e.target.value)} className="flex-1 w-full bg-transparent border-none resize-none focus:ring-0 font-serif text-xl text-stone-700 leading-loose placeholder:text-stone-300 p-0 focus:outline-none" autoFocus/>
                                <div className="flex justify-between items-center pt-8">
                                    <span className="font-mono text-[10px] text-stone-400">{currentContent.split(' ').length} WORDS {lastSaved && `â¢ ${getSavedTime()}`}</span>
                                    <div className="flex gap-4"><button onClick={() => setIsExpanded(false)} className="p-3 rounded-full hover:bg-stone-200 text-stone-500"><Minimize2 size={20}/></button><button onClick={saveEntry} className="p-3 rounded-full bg-ink text-white hover:bg-accent shadow-xl"><Save size={20}/></button></div>
                                </div>
                            </div>
                        </motion.div>
                    </Portal>
                )}
            </AnimatePresence>
          </>
        );
      };

      const InteractiveCard = ({ children, id, activeId, onClick, className = "" }) => {
        const isActive = activeId === id;
        const isFocusMode = activeId !== GridSection.NONE;
        
        // If we are in focus mode, and this card is NOT active, we hide it completely to give full screen to active card
        if (isFocusMode && !isActive) return null;

        return (
          <motion.div
            layout
            onClick={(e) => { e.stopPropagation(); onClick(id); }}
            initial={{ opacity: 0, y: 20 }}
            animate={{ 
                opacity: 1,
                scale: 1, 
                zIndex: isActive ? 50 : 0
            }}
            transition={{ duration: 0.8, ease: [0.16, 1, 0.3, 1], layout: { duration: 0.5, ease: "circOut" } }}
            className={`bg-white/80 backdrop-blur-md border border-white/50 shadow-[0_4px_20px_rgb(0,0,0,0.02)] hover:shadow-[0_8px_30px_rgb(0,0,0,0.05)] transition-shadow duration-500 overflow-hidden ${className} ${isActive ? 'shadow-2xl ring-1 ring-black/5' : ''} cursor-pointer`}
            style={{ transformStyle: 'preserve-3d', perspective: '1000px' }}
          >
            {children}
            {isActive && <motion.button initial={{ opacity: 0 }} animate={{ opacity: 1 }} className="absolute top-4 right-4 p-2 rounded-full bg-white/10 text-white hover:bg-white/30 z-50 backdrop-blur-md" onClick={(e) => { e.stopPropagation(); onClick(GridSection.NONE); }}><Minimize2 size={16}/></motion.button>}
          </motion.div>
        );
      };

      const App = () => {
        const [activeSection, setActiveSection] = useState(GridSection.NONE);
        const [mobileTab, setMobileTab] = useState(GridSection.POMODORO);
        const [isAuthenticated, setIsAuthenticated] = useState(false);
        const [isPomodoroActive, setIsPomodoroActive] = useState(false);

        const handleBackgroundClick = () => { if (activeSection !== GridSection.NONE && !isPomodoroActive) setActiveSection(GridSection.NONE); };

        // When Pomodoro starts, it forces Focus Mode (Full Screen)
        const handlePomodoroStart = () => {
            setIsPomodoroActive(true);
            setActiveSection(GridSection.POMODORO);
        };

        const handlePomodoroStop = () => {
            setIsPomodoroActive(false);
            // Optionally remain in focus mode or auto-minimize. 
            // Staying in focus mode is better UX so user can decide to leave.
        };

        const getGridClass = (section) => {
            if (activeSection === GridSection.NONE) {
                // Default Bento Grid
                if (section === GridSection.POMODORO) return "col-span-1 md:col-span-8 lg:col-span-8 row-span-2";
                if (section === GridSection.MONEY) return "col-span-1 md:col-span-4 lg:col-span-4 row-span-1";
                if (section === GridSection.BOOKMARKS) return "col-span-1 md:col-span-4 lg:col-span-4 row-span-1";
                if (section === GridSection.TODO) return "col-span-1 md:col-span-4 lg:col-span-4 row-span-1";
                if (section === GridSection.JOURNAL) return "col-span-1 md:col-span-4 lg:col-span-4 row-span-1";
                if (section === GridSection.LISTS) return "col-span-1 md:col-span-4 lg:col-span-4 row-span-1";
            } else {
                // FOCUS MODE: Active grid takes full screen
                if (section === activeSection) return "col-span-1 md:col-span-12 row-span-full z-50 h-[85vh]";
                return "hidden"; 
            }
            return "";
        };

        const renderMobileContent = () => {
          switch(mobileTab) {
            case GridSection.POMODORO: return <Pomodoro isActiveProp={isPomodoroActive} onStart={() => setIsPomodoroActive(true)} onStop={() => setIsPomodoroActive(false)} />;
            case GridSection.TODO: return <TodoList />;
            case GridSection.JOURNAL: return <Journal />;
            case GridSection.MONEY: return <MoneyTracker />;
            case GridSection.BOOKMARKS: return <Bookmarks />;
            case GridSection.LISTS: return <MultiList />;
            default: return <Pomodoro isActiveProp={isPomodoroActive} onStart={() => setIsPomodoroActive(true)} onStop={() => setIsPomodoroActive(false)} />;
          }
        };

        if (!isAuthenticated) return <div id="sun-app-root"><CustomCursor /><LockScreen onUnlock={() => setIsAuthenticated(true)} /></div>;

        return (
          <div id="sun-app-root" onClick={handleBackgroundClick}>
            <div className="bg-grid-pattern"></div>
            <div className="bg-noise"></div>
            
            <div className="min-h-screen p-4 md:p-12 pb-32 hardware-accelerated">
                <CustomCursor />
                <motion.header className="mb-10 flex justify-between items-end max-w-[1800px] mx-auto relative z-10 pointer-events-none" animate={{ opacity: activeSection ? 0 : 1, y: activeSection ? -20 : 0 }}>
                <div className="pointer-events-auto">
                    <h1 className="font-serif text-5xl md:text-8xl mb-2 text-ink tracking-tight">Sun Screen.</h1>
                    <div className="flex items-center gap-4"><div className="h-[1px] w-8 bg-accent"></div><p className="font-mono text-[9px] text-stone-500 tracking-[0.3em] uppercase">Protection & Clarity</p></div>
                </div>
                <div className="hidden md:block text-right"><p className="font-mono text-[10px] text-stone-400 tracking-widest uppercase mb-1">{getFormattedDate()}</p></div>
                </motion.header>

                {/* DESKTOP GRID */}
                <motion.main layout className="hidden md:grid grid-cols-1 md:grid-cols-12 auto-rows-[minmax(280px,auto)] gap-4 max-w-[1800px] mx-auto relative z-10 perspective-[2000px]">
                <InteractiveCard id={GridSection.POMODORO} activeId={activeSection} onClick={setActiveSection} className={getGridClass(GridSection.POMODORO)}>
                    <Pomodoro isActiveProp={isPomodoroActive} onStart={handlePomodoroStart} onStop={handlePomodoroStop} />
                </InteractiveCard>
                <InteractiveCard id={GridSection.MONEY} activeId={activeSection} onClick={setActiveSection} className={getGridClass(GridSection.MONEY)}><MoneyTracker /></InteractiveCard>
                <InteractiveCard id={GridSection.TODO} activeId={activeSection} onClick={setActiveSection} className={getGridClass(GridSection.TODO)}><TodoList /></InteractiveCard>
                <InteractiveCard id={GridSection.JOURNAL} activeId={activeSection} onClick={setActiveSection} className={getGridClass(GridSection.JOURNAL)}><Journal /></InteractiveCard>
                <InteractiveCard id={GridSection.LISTS} activeId={activeSection} onClick={setActiveSection} className={getGridClass(GridSection.LISTS)}><MultiList /></InteractiveCard>
                <InteractiveCard id={GridSection.BOOKMARKS} activeId={activeSection} onClick={setActiveSection} className={getGridClass(GridSection.BOOKMARKS)}><Bookmarks /></InteractiveCard>
                </motion.main>

                {/* MOBILE VIEW */}
                <main className="md:hidden flex flex-col h-[75vh] relative z-10">
                <AnimatePresence mode="wait">
                    <motion.div key={mobileTab} initial={{ opacity: 0, y: 10, scale: 0.98 }} animate={{ opacity: 1, y: 0, scale: 1 }} exit={{ opacity: 0, y: -10, scale: 0.98 }} transition={{ duration: 0.3 }} className="flex-1 bg-white/90 backdrop-blur-md border border-white/40 shadow-xl rounded-sm overflow-hidden">
                        {renderMobileContent()}
                    </motion.div>
                </AnimatePresence>
                </main>

                {/* Mobile Dock */}
                <div className="md:hidden fixed bottom-6 left-1/2 transform -translate-x-1/2 z-50 w-max max-w-[90vw]">
                <div className="flex items-center gap-1 bg-white/90 backdrop-blur-xl border border-white/50 p-2 rounded-2xl shadow-[0_10px_40px_-10px_rgba(0,0,0,0.1)] overflow-x-auto">
                    {[
                        { id: GridSection.POMODORO, Icon: Clock },
                        { id: GridSection.TODO, Icon: Check },
                        { id: GridSection.JOURNAL, Icon: BookOpen },
                        { id: GridSection.MONEY, Icon: Wallet },
                        { id: GridSection.LISTS, Icon: Layers },
                        { id: GridSection.BOOKMARKS, Icon: LinkIcon }
                    ].map(({ id, Icon }) => (
                        <button key={id} onClick={() => setMobileTab(id)} className={`p-3 rounded-xl transition-all ${mobileTab === id ? 'bg-ink text-white shadow-md scale-105' : 'text-stone-400 hover:bg-stone-100'}`}><Icon size={18} /></button>
                    ))}
                </div>
                </div>
                
                <footer className="fixed bottom-0 left-0 w-full p-6 flex justify-between items-center text-stone-300 font-mono text-[9px] uppercase tracking-widest pointer-events-none z-0">
                <span className="hidden md:inline">Â© {new Date().getFullYear()} Sun Screen</span>
                <span className="hidden md:inline">SPF 5000</span>
                </footer>
            </div>
          </div>
        );
      };

      const rootElement = document.getElementById('root');
      if (!rootElement) throw new Error("Could not find root element");
      const root = createRoot(rootElement);
      root.render(<React.StrictMode><App /></React.StrictMode>);
    </script>
  <script type="module" src="/index.tsx"></script>
</body>
</html>
